# LinkChain 挂件链使用方法说明

## 1. 概述

LinkChain 是一个轻量级的链式执行器，通过配置驱动的方式实现数据处理管道。它将数据处理任务分解为多个挂件（Chainware），每个挂件负责特定的处理任务，按顺序执行形成处理链。

## 2. 挂件链基本使用方法

### 2.1 创建执行器

```rust
use linkchain::chain::executor::ChainExecutor;

let mut executor = ChainExecutor::new();
```

### 2.2 添加挂件

```rust
// 添加内置挂件到末尾
executor = executor.insert_chainware("condition", None, None::<fn>, Some(config)).unwrap();

// 添加自定义挂件
executor = executor.insert_chainware("custom", None, Some(custom_callback), Some(config)).unwrap();

// 插入挂件到指定位置
executor = executor.insert_chainware("logger", Some(0), None::<fn>, Some(config)).unwrap(); // 插入到开头
executor = executor.insert_chainware("merge", Some(-2), None::<fn>, Some(config)).unwrap(); // 插入到倒数第二位

// 批量添加挂件（通过JSON数组配置）
let configs = json!([
  {
    "name": "condition",
    "config": {
      "expression": "$.age >= 18"
    }
  },
  {
    "name": "logger",
    "config": {
      "template": "处理用户数据: ${$.username}"
    }
  }
]);
executor = executor.add_chainwares(configs).unwrap();
```

### 2.3 执行处理链

```rust
use linkchain::core::ChainRequest;
use serde_json::json;

let context = ChainRequest::new(json!({"name": "张三", "age": 25}), HashMap::new());
let response = executor.execute(context);
```

## 3. 内置挂件详解

### 3.1 条件判断类挂件

#### 3.1.1 condition (条件判断挂件)

用于基于表达式的条件判断，支持多种比较和函数操作。

**配置参数:**
- `expression`: 条件表达式字符串

**支持的表达式类型:**
1. 基本比较: `$.field == value`, `$.field > 10`, `$.field <= 5`
2. 字符串操作: 
   - `String.startsWith($.field, "prefix")`
   - `String.endsWith($.field, "suffix")`
   - `String.contains($.field, "substr")`
   - `String.matches($.field, "regex")`
3. 类型检查:
   - `Chain.isString($.field)`
   - `Chain.isNumber($.field)`
   - `Chain.isBoolean($.field)`
   - `Chain.isObject($.field)`
   - `Chain.isArray($.field)`
   - `Chain.isNull($.field)`
   - `Chain.isEmpty($.field)`
4. 长度检查: `$.field.length > 5`
5. 逻辑运算: `condition1 && condition2`, `condition1 || condition2`

**示例配置:**
```json
{
  "expression": "$.age >= 18 && $.verified == true"
}
```

#### 3.1.2 regexp_condition (正则条件挂件)

用于基于正则表达式的条件验证。

**配置参数:**
- `pattern`: 正则表达式模式

**示例配置:**
```json
{
  "pattern": "^1[3-9]\\d{9}$"
}
```

### 3.2 数据提取类挂件

#### 3.2.1 extract_json (JSON提取挂件)

从文本中提取JSON对象或数组。

**配置参数:**
- 无特殊配置参数

**示例配置:**
```json
{}
```

#### 3.2.2 json_extract (JSON字段提取挂件)

基于JSONPath从对象中提取指定字段。

**配置参数:**
- `pattern`: JSONPath表达式

**示例配置:**
```json
{
  "pattern": "$.user.profile.name"
}
```

#### 3.2.3 regexp_extract (正则提取挂件)

通过正则表达式从文本中提取内容。

**配置参数:**
- `pattern`: 正则表达式模式

**示例配置:**
```json
{
  "pattern": "\\d{4}-\\d{2}-\\d{2}"
}
```

#### 3.2.4 extract_sql (SQL提取挂件)

从文本中提取SQL语句。

**配置参数:**
- 无特殊配置参数

**示例配置:**
```json
{}
```

#### 3.2.5 extract_map (映射提取挂件)

根据映射规则从输入数据中提取字段组成新对象。

**配置参数:**
- `mapping`: 映射规则对象，键为新字段名，值为JSONPath表达式或模板字符串

**示例配置:**
```json
{
  "mapping": {
    "username": "$.user.name",
    "email": "$.user.email",
    "full_name": "${$.user.first_name} ${$.user.last_name}"
  }
}
```

### 3.3 数据处理类挂件

#### 3.3.1 map_fields (字段映射挂件)

将对象字段进行重命名和转换。

**配置参数:**
- `mapping`: 映射规则对象
- `overwrite`: 是否在原对象基础上添加映射字段（默认true）

**示例配置:**
```json
{
  "mapping": {
    "user_name": "$.name",
    "user_age": "$.age"
  },
  "overwrite": true
}
```

#### 3.3.2 merge (数据合并挂件)

将额外数据合并到结果中。

**配置参数:**
- `data_path`: 数据路径（JSONPath格式）

**示例配置:**
```json
{
  "data_path": "$params.extra_info"
}
```

### 3.4 网络安全类挂件

#### 3.4.1 ip_blacklist (IP黑名单挂件)

检查IP地址是否在黑名单中。

**配置参数:**
- `ip_list`: IP地址列表，支持单个IP和CIDR格式，用逗号分隔

**示例配置:**
```json
{
  "ip_list": "192.168.1.100,10.0.0.0/8"
}
```

#### 3.4.2 ip_whitelist (IP白名单挂件)

检查IP地址是否在白名单中。

**配置参数:**
- `ip_list`: IP地址列表，支持单个IP和CIDR格式，用逗号分隔

**示例配置:**
```json
{
  "ip_list": "192.168.1.0/24,127.0.0.1"
}
```

### 3.5 辅助工具类挂件

#### 3.5.1 logger (日志记录挂件)

记录处理过程和调试信息。

**配置参数:**
- `template`: 日志模板字符串，支持JSONPath变量替换

**示例配置:**
```json
{
  "template": "用户 ${$.username} 执行了 ${$.action} 操作"
}
```

## 4. 使用示例

### 4.1 用户注册验证流程

```rust
let mut executor = ChainExecutor::new();

// 添加IP白名单检查
executor = executor.insert_chainware(
    "ip_whitelist",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "ip_list".to_string() => json!("192.168.0.0/16,10.0.0.0/8")
        }
    })
).unwrap();

// 添加数据格式验证
executor = executor.insert_chainware(
    "regexp_condition",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "pattern".to_string() => json!("^1[3-9]\\d{9}$")
        }
    })
).unwrap();

// 添加年龄条件检查
executor = executor.insert_chainware(
    "condition",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "expression".to_string() => json!("$.age >= 18")
        }
    })
).unwrap();

// 添加日志记录
executor = executor.insert_chainware(
    "logger",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "template".to_string() => json!("新用户注册: ${$.username}")
        }
    })
).unwrap();

let context = ChainRequest::new(json!({
    "username": "张三",
    "phone": "13812345678",
    "age": 25
}), HashMap::new());
let response = executor.execute(context);
```

### 4.2 数据处理管道

```rust
let mut executor = ChainExecutor::new();

// 从原始数据中提取JSON
executor = executor.insert_chainware("extract_json", None, None::<fn>, None).unwrap();

// 提取用户信息字段
executor = executor.insert_chainware(
    "extract_map",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "mapping".to_string() => json!({
                "user_id": "$.id",
                "user_name": "$.name",
                "user_email": "$.email"
            })
        }
    })
).unwrap();

// 字段映射转换
executor = executor.insert_chainware(
    "map_fields",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "mapping".to_string() => json!({
                "id": "$.user_id",
                "name": "$.user_name",
                "email": "$.user_email"
            }),
            "overwrite".to_string() => json!(false)
        }
    })
).unwrap();

// 合并额外信息
executor = executor.insert_chainware(
    "merge",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "data_path".to_string() => json!("$params.system_info")
        }
    })
).unwrap();

let context = ChainRequest::new(json!(r#"用户信息：{"id": 123, "name": "张三", "email": "zhang@example.com"}"#), HashMap::new());
let response = executor.execute(context);
```

### 4.3 API安全过滤链

```rust
let mut executor = ChainExecutor::new();

// IP黑名单过滤
executor = executor.insert_chainware(
    "ip_blacklist",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "ip_list".to_string() => json!("203.0.113.0/24,198.51.100.0/24")
        }
    })
).unwrap();

// IP白名单过滤（二选一）
// executor = executor.insert_chainware(
//     "ip_whitelist",
//     None,
//     None::<fn>,
//     Some(ChainwareConfig {
//         config: hashmap! {
//             "ip_list".to_string() => json!("192.168.0.0/16,10.0.0.0/8")
//         }
//     })
// ).unwrap();

// 请求数据验证
executor = executor.insert_chainware(
    "condition",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "expression".to_string() => json!("$.api_key == \"valid_key\"")
        }
    })
).unwrap();

// 记录访问日志
executor = executor.insert_chainware(
    "logger",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "template".to_string() => json!("API访问: ${$.endpoint} from ${$meta.ip_address}")
        }
    })
).unwrap();

let mut context = ChainRequest::new(json!({
    "endpoint": "/api/users",
    "api_key": "valid_key"
}), HashMap::new());

context.meta.insert("ip_address".to_string(), json!("192.168.1.100"));
let response = executor.execute(context);
```

### 4.4 日志分析与提取

```rust
let mut executor = ChainExecutor::new();

// 从日志中提取JSON数据
executor = executor.insert_chainware("extract_json", None, None::<fn>, None).unwrap();

// 使用正则提取特定信息
executor = executor.insert_chainware(
    "regexp_extract",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "pattern".to_string() => json!("ERROR\\s+(.*)")
        }
    })
).unwrap();

// 提取关键字段
executor = executor.insert_chainware(
    "json_extract",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "pattern".to_string() => json!("$.level")
        }
    })
).unwrap();

// 记录处理结果
executor = executor.insert_chainware(
    "logger",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "template".to_string() => json!("日志级别: ${$}")
        }
    })
).unwrap();

let context = ChainRequest::new(json!("2024-01-15 ERROR {\"level\":\"error\",\"message\":\"Database connection failed\"}"), HashMap::new());
let response = executor.execute(context);
```

### 4.5 数据清洗与转换

```rust
let mut executor = ChainExecutor::new();

// 条件过滤：只处理有效数据
executor = executor.insert_chainware(
    "condition",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "expression".to_string() => json!("$.status == \"active\" && $.value > 0")
        }
    })
).unwrap();

// 字段映射：标准化字段名
executor = executor.insert_chainware(
    "map_fields",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "mapping".to_string() => json!({
                "user_id": "$.id",
                "user_name": "$.name",
                "created_at": "$.create_time"
            }),
            "overwrite".to_string() => json!(true)
        }
    })
).unwrap();

// 提取映射：创建新的数据结构
executor = executor.insert_chainware(
    "extract_map",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "mapping".to_string() => json!({
                "id": "$.user_id",
                "name": "$.user_name",
                "timestamp": "${$meta.timestamp}",
                "processed": true
            })
        }
    })
).unwrap();

// 记录处理完成
executor = executor.insert_chainware(
    "logger",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "template".to_string() => json!("数据处理完成: ${$.name}")
        }
    })
).unwrap();

let mut context = ChainRequest::new(json!({
    "id": 123,
    "name": "张三",
    "status": "active",
    "value": 100,
    "create_time": "2024-01-15T10:30:00Z"
}), HashMap::new());

context.meta.insert("timestamp".to_string(), json!("2024-01-15T10:35:00Z"));
let response = executor.execute(context);
```

### 4.6 复杂条件验证链

```rust
let mut executor = ChainExecutor::new();

// 多重条件验证：邮箱格式
executor = executor.insert_chainware(
    "regexp_condition",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "pattern".to_string() => json!("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$")
        }
    })
).unwrap();

// 多重条件验证：密码强度
executor = executor.insert_chainware(
    "condition",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "expression".to_string() => json!("$.password.length >= 8 && Chain.isString($.password) && String.contains($.password, \"[A-Z]\") && String.contains($.password, \"[a-z]\") && String.contains($.password, \"[0-9]\")")
        }
    })
).unwrap();

// 业务规则验证
executor = executor.insert_chainware(
    "condition",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "expression".to_string() => json!("$.age >= 13 && $.age <= 120 && $.terms_accepted == true")
        }
    })
).unwrap();

// 记录验证结果
executor = executor.insert_chainware(
    "logger",
    None,
    None::<fn>,
    Some(ChainwareConfig {
        config: hashmap! {
            "template".to_string() => json!("用户验证通过: ${$.email}")
        }
    })
).unwrap();

let context = ChainRequest::new(json!({
    "email": "user@example.com",
    "password": "Password123",
    "age": 25,
    "terms_accepted": true
}), HashMap::new());
let response = executor.execute(context);
```

## 5. 最佳实践

1. **配置驱动**: 尽量使用配置而非硬编码来定义处理逻辑
2. **链式设计**: 将复杂处理任务分解为多个简单的挂件
3. **错误处理**: 合理使用条件挂件进行数据验证，提前拦截无效数据
4. **日志记录**: 在关键节点添加日志挂件，便于调试和监控
5. **安全控制**: 使用IP过滤挂件保护API安全
6. **性能优化**: 避免在链中添加不必要的处理步骤

## 6. 注意事项

1. 挂件按添加顺序执行，数据从前一个挂件流向后一个挂件
2. 某些挂件（如条件类）可能会中断链的执行
3. 配置参数需要符合各挂件的规范要求
4. IP过滤挂件从`request.meta.ip_address`获取客户端IP
5. JSONPath表达式支持`$`（当前数据）、`$params`（请求参数）、`$meta`（元数据）等上下文