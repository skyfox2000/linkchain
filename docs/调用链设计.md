# LinkChain 调用链执行器设计文档

## 1. 项目概述

LinkChain 是一个轻量级的调用链执行器库，专门设计用于API网关过滤、数据处理管道的前置后置处理、以及服务接口的数据过滤等辅助处理场景。项目通过配置驱动的方式实现数据流处理，无需开发即可完成复杂的数据过滤和转换逻辑。

### 1.1 核心定位

- **辅助处理工具**: 专注于数据的辅助处理，不承担核心业务逻辑
- **API网关过滤**: 为API网关提供请求过滤、验证、转换等功能
- **数据管道增强**: 作为数据处理管道的前置或后置处理节点
- **服务接口外挂**: 为现有服务接口提供可插拔的数据处理能力
- **简化流程目的**: 通过标准化挂件简化复杂的数据处理流程

### 1.2 核心特性

- **配置驱动执行**: 所有处理逻辑通过JSON配置控制，无需编程开发
- **单向顺序处理**: 挂件按注册顺序单向执行，数据在挂件间流转
- **数据不变性保证**: 原始请求参数和元数据在整个链中严格不变
- **轻量级架构**: 专注于数据过滤转换，避免复杂的业务逻辑处理
- **即插即用**: 挂件支持热配置，通过配置文件即可调整处理逻辑
- **标准化输出**: 统一的JSON格式输入输出，便于系统集成

### 1.3 设计原则

- **配置优于编程**: 通过配置文件控制所有处理逻辑，避免代码开发
- **简单优于复杂**: 专注于数据过滤转换，不处理复杂业务逻辑
- **辅助优于核心**: 作为辅助处理工具，不替代核心业务流程
- **标准优于定制**: 提供标准化挂件，覆盖常见数据处理场景
- **安全优于性能**: 确保数据处理的安全性和一致性

## 2. 系统架构设计

### 2.1 文件目录结构

```
src/
├── lib.rs                    # 库入口文件，导出公共API
├── core/                     # 核心模块
│   ├── mod.rs               # 核心模块导出
│   ├── context.rs           # 请求响应上下文定义
│   ├── status.rs            # 执行状态枚举定义
│   └── utils.rs             # 核心工具函数
├── chainware/               # 挂件框架
│   ├── mod.rs               # 挂件框架导出
│   ├── core.rs              # 挂件核心接口定义
│   └── config.rs            # 挂件配置结构定义
├── chain/                   # 链执行器
│   ├── mod.rs               # 链模块导出
│   └── executor.rs          # 链执行逻辑实现
├── utils/                   # 工具模块
│   ├── mod.rs               # 工具模块导出
│   └── json_path.rs         # JSONPath解析器
├── builtin/                 # 内置挂件库
│   ├── mod.rs               # 内置挂件导出
│   ├── registry.rs          # 挂件注册管理
│   ├── condition.rs         # 条件判断挂件
│   ├── regexp_condition.rs  # 正则条件挂件
│   ├── ip_blacklist.rs      # IP黑名单挂件
│   ├── ip_whitelist.rs      # IP白名单挂件
│   ├── extract_json.rs      # JSON提取挂件
│   ├── json_extract.rs      # JSON字段提取挂件
│   ├── regexp_extract.rs    # 正则提取挂件
│   ├── extract_sql.rs       # SQL提取挂件
│   ├── extract_map.rs       # 映射提取挂件
│   ├── map_fields.rs        # 字段映射挂件
│   ├── merge.rs             # 数据合并挂件
│   └── logger.rs            # 日志记录挂件
├── types/                   # 类型定义模块
└── plugins/                 # 扩展插件模块
```

### 2.2 核心数据结构

#### 2.2.1 请求上下文 (ChainRequest)
请求上下文包含执行链所需的所有输入信息：
- **params**: 输入数据（JSON格式）
- **meta**: 元数据（包含所有额外信息，以HashMap<String, serde_json::Value>形式存储）
- **start_time**: 执行开始时间

#### 2.2.2 响应上下文 (ChainResponse)
响应上下文包含执行结果和状态信息：
- **status**: 执行状态（Continue/Completed/Error/Reject）
- **data**: 输出数据（JSON格式）
- **meta**: 响应元数据（以HashMap<String, serde_json::Value>形式存储）
- **start_time**: 执行开始时间
- **end_time**: 执行结束时间

#### 2.2.3 执行状态 (ChainStatus)
执行状态枚举定义了链执行过程中的各种状态：
- **Continue**: 继续执行（核心状态）
- **Completed**: 执行完成
- **Error**: 数据异常错误
- **Reject**: 拒绝执行

#### 2.2.4 挂件配置 (ChainwareConfig)
挂件配置结构用于存储挂件的配置参数：
- **config**: 配置参数（通用参数，支持任意类型，以HashMap<String, serde_json::Value>形式存储）

#### 2.2.5 挂件接口 (Chainware)
链挂件接口定义了所有挂件需要实现的核心方法：
- **name()**: 获取挂件名称
- **process()**: 处理方法，实现挂件的核心逻辑

### 2.3 核心组件架构

#### 2.3.1 链执行器 (ChainExecutor)
**文件位置**: `src/chain/executor.rs`
**功能职责**: 管理挂件列表，按序执行挂件，处理数据流转和状态控制

#### 2.3.2 挂件包装器 (ChainwareWrapper)
**文件位置**: `src/chainware/core.rs`
**功能职责**: 包装挂件实现，提供配置支持和启用状态检查

#### 2.3.3 挂件注册器 (Registry)
**文件位置**: `src/builtin/registry.rs`
**功能职责**: 管理内置挂件的注册和实例化

#### 2.3.4 JSONPath处理器
**文件位置**: `src/utils/json_path.rs`
**功能职责**: 提供JSONPath数据访问，支持数据查询和模板处理

## 3. 链执行流程设计

### 3.1 链执行器处理流程设计
链执行器的处理流程设计包括以下步骤：
1. **数据初始化**: 将请求参数作为初始数据
2. **顺序执行**: 按注册顺序遍历所有挂件节点  
3. **数据流转**: 每个挂件的输出成为下一个挂件的输入
4. **状态控制**: 根据挂件返回的状态决定是否继续
5. **自动完成**: 所有挂件执行完毕自动设置为Completed状态

### 3.2 挂件包装器执行流程设计
挂件包装器的执行流程设计包括：
1. **启用检查**: 检查挂件是否启用，禁用的挂件直接跳过
2. **调用处理**: 调用实际挂件的process方法
3. **状态同步**: 仅在Continue状态时更新响应数据
4. **结果返回**: 返回挂件处理结果

### 3.3 数据流转机制设计

#### 数据在挂件间的流转设计
数据在挂件间的流转遵循严格的链式处理原则：
- **初始数据**: ChainRequest.params 作为第一个挂件的输入数据
- **链式传递**: 每个挂件的输出成为下一个挂件的输入数据
- **最终结果**: 最后一个挂件的输出存储在 ChainResponse.data 中
- **数据隔离**: 每个挂件处理独立的数据副本，确保数据安全

**链式数据流转流程**:
```
ChainRequest.params (初始数据)
    ↓
挂件1.process() → 输出数据1
    ↓
挂件2.process() → 输出数据2  
    ↓
挂件3.process() → 输出数据3
    ↓
...
    ↓
挂件N.process() → 输出数据N
    ↓
ChainResponse.data (最终结果)
```

**状态控制流程**:
- 如果挂件返回 `ChainStatus::Continue` → 继续执行下一个挂件
- 如果挂件返回 `ChainStatus::Completed` → 立即结束链，返回当前结果
- 如果挂件返回 `ChainStatus::Error` → 立即终止链，返回错误状态
- 如果挂件返回 `ChainStatus::Reject` → 立即拒绝链，返回拒绝状态

**数据流详细说明**:
1. **初始输入阶段**: 
   - 输入: ChainRequest.params (原始请求参数)
   - 处理: 挂件1接收初始数据进行处理
   - 状态检查: 如果非Continue状态则立即返回
   - 输出: 输出数据1 (传递给挂件2)

2. **中间处理阶段**:
   - 输入: 上一个挂件的输出数据
   - 处理: 当前挂件基于输入数据进行业务处理
   - 状态检查: 如果非Continue状态则立即返回
   - 输出: 新的输出数据 (传递给下一个挂件)

3. **最终输出阶段**:
   - 输入: 挂件N-1的输出数据
   - 处理: 最后一个挂件完成最终处理
   - 状态检查: 无论状态如何都结束链
   - 输出: 最终结果数据

4. **结果存储阶段**:
   - 最终结果存储在 ChainResponse.data 中
   - 执行状态存储在 ChainResponse.status 中

**链式处理核心特性**:
- **严格顺序**: 挂件必须按注册顺序执行，顺序影响结果
- **数据依赖**: 每个挂件的输入完全依赖于前一个挂件的输出
- **单向流动**: 数据只能从前向后流动，不可逆向传递
- **状态传递**: 执行状态在挂件间传递，控制流程继续或终止
- **错误隔离**: 单个挂件错误不会影响其他挂件的正常功能
- **数据安全**: 每个挂件处理数据副本，原始数据保持不变

#### 上下文数据访问设计
系统支持三种上下文数据访问方式：
- **$params**: 原始请求参数（整个链执行过程中严格不变）
- **$meta**: 请求元数据（整个链执行过程中严格不变）  
- **$**: 当前数据（在挂件间流转变化，每个挂件处理独立副本）

### 3.4 挂件添加机制设计
挂件添加机制支持以下功能设计：
1. **优先级**: 自定义回调优先于内置挂件
2. **注册查找**: 从全局注册器查找内置挂件
3. **配置包装**: 将挂件和配置包装到ChainwareWrapper中
4. **顺序添加**: 按添加顺序构建执行链
5. **位置插入**: 支持在指定位置插入挂件
6. **批量添加**: 支持通过JSON数组配置批量添加挂件

## 4. 内置挂件库设计

### 4.1 条件验证类挂件

#### 4.1.1 condition (条件判断挂件)
**文件位置**: `src/builtin/condition.rs`
**功能设计**: 基于条件表达式或JSONPath进行数据过滤
**支持的条件格式**:
- 基本比较: `$input.field == value`, `$input > 10`
- 字符串操作: `String.startsWith($input.field, "prefix")`
- 类型检查: `Chain.isString($input.field)`, `Chain.isNumber($input.field)`
- 长度检查: `$input.field.length > 5`, `$input.array.length == 0`
- 复杂表达式: 支持 `&&` 和 `||` 逻辑运算符

#### 4.1.2 regexp_condition (正则条件挂件) 
**文件位置**: `src/builtin/regexp_condition.rs`
**功能设计**: 基于正则表达式的文本匹配和验证

### 4.2 数据提取类挂件

#### 4.2.1 extract_json (JSON提取挂件)
**文件位置**: `src/builtin/extract_json.rs`
**功能设计**: 从文本中按出现顺序智能提取JSON对象和数组
**核心特性**:
- 按字符顺序扫描，支持 `{` 对象和 `[` 数组
- 智能括号匹配，确保JSON结构完整
- 自动验证JSON格式有效性
- 优先返回第一个有效的JSON结构

#### 4.2.2 json_extract (JSON字段提取挂件)
**文件位置**: `src/builtin/json_extract.rs`
**功能设计**: 从JSON数据中提取指定字段

#### 4.2.3 regexp_extract (正则提取挂件)
**文件位置**: `src/builtin/regexp_extract.rs`
**功能设计**: 使用正则表达式从文本中提取数据

#### 4.2.4 extract_sql (SQL提取挂件)
**文件位置**: `src/builtin/extract_sql.rs`
**功能设计**: 从文本中提取SQL语句

### 4.3 数据处理类挂件

#### 4.3.1 map_fields (字段映射挂件)
**文件位置**: `src/builtin/map_fields.rs`
**功能设计**: 将对象的字段进行重命名和转换
**业务模式**:
- **overwrite=true**: 在原对象基础上添加映射字段（容错性强）
- **overwrite=false**: 创建新对象只包含映射字段（严格模式）
**支持场景**:
- 对象字段映射：复制原对象，添加新字段
- 数组元素映射：循环处理数组中的每个对象元素
- JSONPath模板：支持复杂的路径表达式

#### 4.3.2 merge (数据合并挂件)
**文件位置**: `src/builtin/merge.rs`
**功能设计**: 合并多个数据源或对象

#### 4.3.3 extract_map (映射提取挂件)
**文件位置**: `src/builtin/extract_map.rs`
**功能设计**: 按映射规则提取和重组数据

### 4.4 网络安全类挂件

#### 4.4.1 ip_blacklist (IP黑名单挂件)
**文件位置**: `src/builtin/ip_blacklist.rs`
**功能设计**: 基于IP地址的黑名单过滤
**核心特性**:
- 支持单个IP地址精确匹配
- 支持CIDR网段格式 (如 `192.168.1.0/24`)
- 自动IPv4和IPv6地址处理
- 从`request.meta.ip_address`获取客户端IP
- 匹配黑名单时返回`ChainStatus::Reject`

#### 4.4.2 ip_whitelist (IP白名单挂件)
**文件位置**: `src/builtin/ip_whitelist.rs`
**功能设计**: 基于IP地址的白名单过滤
**核心特性**: 与黑名单挂件类似，但逻辑相反

### 4.5 辅助工具挂件

#### 4.5.1 logger (日志记录挂件)
**文件位置**: `src/builtin/logger.rs`
**功能设计**: 记录处理过程和调试信息

### 4.6 挂件注册管理

#### registry (挂件注册器)
**文件位置**: `src/builtin/registry.rs`
**功能设计**: 管理所有内置挂件的注册和实例化
**提供的挂件类型**:
- `condition` - 条件判断挂件
- `regexp_condition` - 正则条件挂件
- `ip_blacklist` - IP黑名单挂件
- `ip_whitelist` - IP白名单挂件
- `extract_json` - JSON提取挂件
- `json_extract` - JSON字段提取挂件
- `regexp_extract` - 正则提取挂件
- `extract_sql` - SQL提取挂件
- `extract_map` - 映射提取挂件
- `map_fields` - 字段映射挂件
- `merge` - 数据合并挂件
- `logger` - 日志记录挂件

## 5. 典型应用场景

### 5.1 API网关数据过滤
**应用场景**: 在API网关中作为请求预处理模块
**处理链示例**:
```
IP黑名单过滤 -> 条件验证 -> JSON提取 -> 字段映射 -> 日志记录
```
**配置驱动**: 通过配置文件控制过滤规则，无需修改代码

### 5.2 数据处理管道前置处理
**应用场景**: 在数据处理管道前对原始数据进行清洗和标准化
**处理链示例**:
```
JSON提取 -> 条件过滤 -> 字段映射 -> 数据合并
```
**简化目的**: 标准化数据格式，减少后续处理复杂度

### 5.3 服务接口数据增强
**应用场景**: 为现有服务接口提供外挂式数据处理能力
**处理链示例**:
```
原始数据 -> 字段提取 -> 条件判断 -> 数据映射 -> 增强结果
```
**辅助处理**: 不改变核心业务逻辑，通过配置增强数据处理能力

### 5.4 配置驱动的优势
- **无需开发**: 所有处理逻辑通过JSON配置控制
- **快速调整**: 修改配置即可改变处理行为
- **标准化**: 提供11个内置挂件覆盖常见场景
- **组合灵活**: 不同挂件可灵活组合满足复杂需求

## 6. 技术特性总结

### 6.1 架构特性
- **轻量级设计**: 专注于数据辅助处理，避免重量级框架复杂性
- **配置优于编程**: 通过JSON配置控制所有处理逻辑
- **单向数据流**: 数据在挂件间单向流转，逻辑清晰
- **状态驱动**: 通过ChainStatus控制流程，支持错误处理和提前终止

### 6.2 数据安全特性
- **原始数据不变**: request.params和request.meta在整个处理过程中保持不变
- **流转数据隔离**: 每个挂件处理独立的数据副本
- **错误隔离**: 单个挂件错误不影响整体架构稳定性

### 6.3 扩展特性
- **内置挂件丰富**: 提供11个常用挂件覆盖主要处理场景
- **自定义挂件**: 支持通过回调函数创建自定义处理逻辑
- **配置灵活**: 每个挂件支持独立配置和启用控制
- **位置控制**: 支持在链中任意位置插入挂件
- **批量配置**: 支持通过JSON数组批量配置挂件

LinkChain通过简洁的设计和配置驱动的理念，为API网关过滤、数据处理管道和服务接口增强等场景提供了高效的辅助处理解决方案。